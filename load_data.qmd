---
title: "Data Loading Script"
format: html
---

## I have written in quarto format because it makes my workflow cleaner. We can change into .R format quite easily later (not necessary). - Keval 

## PROBLEM: Spacing error when loading file. If you can figure it out lmk. 
```{r}
#load libraries

library(haven)     # For .dta files
library(readr)     # For fixed-width PSID .txt files
library(dplyr)     # For data manipulation
library(purrr)     # For mapping over years

```

```{r}
library(SAScii)
# Define the paths for 1970
test_txt_path <- "data/raw/fam1970/FAM1970.txt"
test_sas_path <- "data/raw/fam1970/FAM1970.sas"

# Load the data
psid_1970_test <- read.SAScii(
    fn      = test_txt_path,
    sas_ri = test_sas_path
)

# Check the number of columns and rows
dim(psid_1970_test)
```
```{r}
readLines("data/raw/fam1970/FAM1970.txt", n = 5)

nchar(readLines("data/raw/fam1970/FAM1970.txt", n = 1))

cat(readLines("data/raw/fam1970/FAM1970.txt", n = 1), "\n")

```
```{r}
# Food Stamp rollout (treatment)
fs_rollout <- read_dta("data/processed/fsdatabyfips.dta")

# 1960 county characteristics
county60 <- read_dta("data/processed/fscbdata_short.dta")

# BEA transfers (used for robustness)
transfers <- read_dta("data/processed/reistran.dta")

#sanity check
glimpse(fs_rollout)
glimpse(county60)
glimpse(transfers)
```
```{r}
library(SAScii)

fam1970 <- read.SAScii(
  "data/raw/fam1970/FAM1970.txt",
  "data/raw/fam1970/FAM1970.sas"
)
```
```{r}
dim(fam1970)                  # how many rows / columns?
head(names(fam1970), 20)      # first 20 variable names
fam1970[1, 1:20] 
```
```{r}
library(SAScii)
library(purrr)

load_psid_year <- function(year) {
  txt_path <- sprintf("data/raw/fam%d/FAM%d.txt", year, year)
  sas_path <- sprintf("data/raw/fam%d/FAM%d.sas", year, year)
  
  message("Loading PSID year: ", year)
  
  df <- read.SAScii(
    fn = txt_path,
    sas_ri = sas_path
  )
  
  df$year <- year
  df
}
```
```{r}
psid_years <- 1968:1978

psid_all <- map_dfr(psid_years, load_psid_year)
```
```{r}
dim(psid_all)
table(psid_all$year)
head(names(psid_all))
```


```{r}
dim(psid_all)
table(psid_all$year)
head(names(psid_all))
```
```{r}
"V1101" %in% names(psid_all)

# Peek at a slice of names around where 1970 variables live
names(psid_all)[1:50]
names(psid_all)[550:650]
tail(names(psid_all), 50)
```
```{r}
saveRDS(psid_all, "data/processed/psid_1968_1978_raw.rds")

```
```{r}
psid_raw <- readRDS("data/processed/psid_1968_1978_raw.rds")

```

```{r}
dim(psid_all)
dim(psid_raw)

identical(psid_all, psid_raw)
```

```{r}
# Dimensions
dim(psid_raw)

# Years covered and counts per year
table(psid_raw$year)

# First few variable names
head(names(psid_raw), 50)

# Last few variable names
tail(names(psid_raw), 50)

```

```{r}
"V93" %in% names(psid_raw)
"V94" %in% names(psid_raw)
table(psid_raw$year, !is.na(psid_raw$V93))
table(psid_raw$year, !is.na(psid_raw$V94))

```
```{r}
psid_with_state <- psid_raw %>%
    mutate(state_psid = case_when(
        year == 1968 ~ V93,
        year == 1969 ~ V537,
        year == 1970 ~ V1103,
        year == 1971 ~ V1803,
        year == 1972 ~ V2403,
        year == 1973 ~ V3003,
        year == 1974 ~ V3403,
        year == 1975 ~ V3803,
        year == 1976 ~ V4303,
        year == 1977 ~ V5203,
        year == 1978 ~ V5703,
        TRUE ~ NA_real_
    ))

```


```{r}
table(psid_with_state$state_psid, useNA="ifany")
```